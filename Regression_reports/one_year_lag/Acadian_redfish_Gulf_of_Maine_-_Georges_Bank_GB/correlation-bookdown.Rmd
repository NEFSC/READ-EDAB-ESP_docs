---
title: "`r paste(params$species_ID, 'Preliminary ESP regressions')`"
author: "Abigail Tyrell"
date: "`r format(Sys.time(), '%d %b %Y')`"
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    split_by: section
documentclass: book
always_allow_html: true
github-repo: NOAA-EDAB/NEesp
params:
  lag: 0 # lag for correlations
  remove_recent: FALSE
  cache: FALSE
  stock: 
  epu: MAB # epu options: GB, GOM, MAB, SS, All, OTHER, MA, NE, all 
  region: "" # the stock region
  path: "" # figure path
  save: FALSE
  out: "html"
---

```{r setup, include = FALSE}
if (params$stock == "Monkfish") {
  stock <- assessmentdata::stockAssessmentData %>%
    dplyr::filter(
      Species == "Goosefish",
      Region == params$region
    ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(max_year = max(AssessmentYear)) %>%
    dplyr::filter(AssessmentYear == max_year) %>%
    dplyr::rename(Time = Year)
} else {
  stock <- assessmentdata::stockAssessmentData %>%
    dplyr::filter(
      Species == params$stock,
      Region == params$region
    ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(max_year = max(AssessmentYear)) %>%
    dplyr::filter(AssessmentYear == max_year) %>%
    dplyr::rename(Time = Year)
}

if (params$remove_recent) {
  max_year <- max(stock$Time)
  stock <- stock %>%
    dplyr::filter(Time <= (max_year - 10))
}

output <- c()

recruit_data <- c()
abun_data <- c()
eval_dat <- FALSE # will be overwritten if data exists

bonf_n <- 0
```

```{r, setup2, include = FALSE}
# keep track of chunk names for troubleshooting
last_known <<- "setup"
knitr::knit_hooks$set(hook_name = function(before) {
  capture.output({
    if (before) {
      chunk_name <<- knitr::opts_current$get()$label
      known_name <- stringr::str_detect(chunk_name, "unnamed-chunk-", negate = TRUE)
      if (known_name) {
        last_known <<- chunk_name
      }
    }
  })
})

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  eval = nrow(stock) > 0,
  cache = params$cache,
  results = "asis",
  fig.width = 8,
  out.width = "100%",
  fig.align = "center",
  fig.path = params$path,
  dev = "png",
  dpi = 72,
  fig.retina = 1,
  hook_name = TRUE
)


```

# `r params$stock` {-}
Stock region: `r params$region`

EPU: `r params$epu`

```{r, fail-message, eval = nrow(stock) == 0}
print("Warning! There are no data on this stock under the conditions selected.")
```

```{r, chunks}
names <- knitr::all_labels()
names <- names[-c(1:5)]
```

# Introduction

These are preliminary regressions that compare `r params$region` `r params$stock` catch, abundance, recruitment, and F to various indicators in the `r paste(params$epu, collapse = ", ")` Environmental Protection Units (EPUs) taken from the `ecodata` package. The indicators are lagged by `r params$lag` years.

```{r, fail-message, eval = nrow(stock) == 0}
```


```{r, stop-knit, eval = nrow(stock) == 0}
print("Report generation aborted!")
knitr::knit_exit()
```

# Regression analysis

All regressions are simple linear correlations assessed at the p < 0.5 level. Please note, due to the large number of indicators tested, a certain amount of statistically significant results are expected even if there are no underlying mechanistic connections. These correlations do not necessarily imply causation.


<!--chapter:end:index.Rmd-->

## Trends with time
```{r, time}
test <- stock %>%
  dplyr::mutate(
    Val = Time,
    Var = "Time"
  ) %>%
  dplyr::select(Time, Val, Var) %>%
  dplyr::distinct()
NEesp::render_indicator(test, lab = names[1])
```


<!--chapter:end:01-time-trends.Rmd-->

## Physical indicators

### Temperature-related

#### Cold pool index
```{r, cold-pool}
test <- ecodata::cold_pool
NEesp::render_indicator(test, lab = names[1])
```

#### Warm core rings
```{r, warm}
test <- ecodata::wcr
NEesp::render_indicator(test, lab = names[1])
```

#### Marine heatwave index
```{r, heatwave}
test <- ecodata::heatwave
NEesp::render_indicator(test, lab = names[1])
```

#### Marine heatwave index in the stock region
```{r, heatwave-stock}
test <- ecodata::ESP_heatwave %>%
  dplyr::mutate(Pattern_check = stock_id %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    if (nrow(test) > 0) {
      NEesp::render_indicator(test, lab = names[1])
    }
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

#### GLORYS bottom temperature
```{r, glorys}
test <- ecodata::bottom_temp_glorys
NEesp::render_indicator(test, lab = names[1])
```

#### Long-term sea surface temperature
```{r, sst}
test <- ecodata::long_term_sst
NEesp::render_indicator(test, lab = names[1])
```

#### Sea surface temperature anomaly in EPU
```{r, sst-anom}
test <- ecodata::seasonal_oisst_anom
NEesp::render_indicator(test, lab = names[1])
```

#### Sea surface temperature anomaly in stock region
```{r, sst-anom-stock}
test <- ecodata::ESP_seasonal_oisst_anom %>%
  dplyr::mutate(Pattern_check = ESP %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    if (nrow(test) > 0) {
      NEesp::render_indicator(test, lab = names[1])
    }
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

### Stratification
```{r, strat}
test <- ecodata::stratification
NEesp::render_indicator(test, lab = names[1])
```

### Wind

#### Winter wind speed
```{r, winter-wind}
test <- ecodata::ne_wind %>%
  dplyr::filter(Var %>% stringr::str_detect("winter"))
NEesp::render_indicator(test, lab = names[1])
```

#### Spring wind speed
```{r, spring-wind}
test <- ecodata::ne_wind %>%
  dplyr::filter(Var %>% stringr::str_detect("spring"))
NEesp::render_indicator(test, lab = names[1])
```

#### Summer wind speed
```{r, summer-wind}
test <- ecodata::ne_wind %>%
  dplyr::filter(Var %>% stringr::str_detect("summer"))
NEesp::render_indicator(test, lab = names[1])
```

#### Fall wind speed
```{r, fall-wind}
test <- ecodata::ne_wind %>%
  dplyr::filter(Var %>% stringr::str_detect("fall"))
NEesp::render_indicator(test, lab = names[1])
```

### Gulf Stream Index
```{r, gsi}
test <- ecodata::gsi %>%
  dplyr::mutate(Time = Time %>%
    stringr::str_trunc(width = 4, ellipsis = "") %>%
    as.numeric())
NEesp::render_indicator(test, lab = names[1])
```

### North Atlantic Oscillation
```{r, nao}
test <- ecodata::nao
NEesp::render_indicator(test, lab = names[1])
```

### Species location

#### Species distribution
```{r, species-dist}
test <- ecodata::species_dist
NEesp::render_indicator(test, lab = names[1])
```

#### Northern range
Northernmost survey observation in each year.
```{r, northern-bound}
test <- NEesp::survey %>%
  dplyr::filter(
    Species == params$stock,
    ABUNDANCE > 0
  ) %>% # why are there entries with 0 abundance but >0 biomass??
  dplyr::select(YEAR, LAT) %>%
  dplyr::group_by(YEAR) %>%
  dplyr::mutate(
    Val = max(LAT, na.rm = TRUE),
    Var = "northern_latitude"
  ) %>%
  dplyr::select(-LAT) %>%
  dplyr::rename(Time = YEAR) %>%
  dplyr::distinct()
NEesp::render_indicator(test, lab = names[1])
```

#### Southern range
Southernmost survey observation in each year.
```{r, southern-bound}
test <- NEesp::survey %>%
  dplyr::filter(
    Species == params$stock,
    ABUNDANCE > 0
  ) %>% # why are there entries with 0 abundance but >0 biomass??
  dplyr::select(YEAR, LAT) %>%
  dplyr::group_by(YEAR) %>%
  dplyr::mutate(
    Val = min(LAT, na.rm = TRUE),
    Var = "southern_latitude"
  ) %>%
  dplyr::select(-LAT) %>%
  dplyr::rename(Time = YEAR) %>%
  dplyr::distinct()
NEesp::render_indicator(test, lab = names[1])
```

<!--chapter:end:02-physical-indicators.Rmd-->

## Trophic indicators

### Chlorophyll

#### Annual chlorophyll
```{r, chl-annual}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "ANNUAL"),
    stringr::str_detect(Var, "CHLOR")
  ) %>%
  dplyr::mutate(Time = Time %>%
    stringr::str_replace("A_", "") %>%
    as.numeric())
NEesp::render_indicator(test, lab = names[1])

# data_prep(stock, test, lag = params$lag) %>% knitr::kable()
```

#### Monthly chlorophyll
```{r, chl-month}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "MONTHLY"),
    stringr::str_detect(Var, "CHLOR")
  ) %>%
  dplyr::mutate(
    Time = Time %>%
      stringr::str_replace("M_", ""),
    Year = Time %>%
      stringr::str_trunc(width = 4, ellipsis = ""),
    Month = Time %>%
      stringr::str_trunc(width = 2, side = "left", ellipsis = ""),
    Var = paste(Var, "month", Month, sep = "\n")
  ) %>%
  dplyr::select(-Time) %>%
  dplyr::rename(Time = Year)
NEesp::render_indicator(test, lab = names[1])
```

#### Weekly chlorophyll
```{r, chl-week}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "WEEKLY"),
    stringr::str_detect(Var, "CHLOR")
  ) %>%
  dplyr::mutate(
    Time = Time %>%
      stringr::str_replace("W_", ""),
    Year = Time %>%
      stringr::str_trunc(width = 4, ellipsis = ""),
    Week = Time %>%
      stringr::str_trunc(width = 2, side = "left", ellipsis = ""),
    Var = paste(Var, "week", Week, sep = "\n")
  ) %>%
  dplyr::select(-Time) %>%
  dplyr::rename(Time = Year)
NEesp::render_indicator(test, lab = names[1])
```

### Primary production

#### Annual primary production
```{r, pp-annual}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "ANNUAL"),
    stringr::str_detect(Var, "PPD")
  ) %>%
  dplyr::mutate(Time = Time %>%
    stringr::str_replace("A_", "") %>%
    as.numeric())
NEesp::render_indicator(test, lab = names[1])

# data_prep(stock, test, lag = params$lag) %>% knitr::kable()
```

#### Monthly primary production
```{r, pp-month}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "MONTHLY"),
    stringr::str_detect(Var, "PPD")
  ) %>%
  dplyr::mutate(
    Time = Time %>%
      stringr::str_replace("M_", ""),
    Year = Time %>%
      stringr::str_trunc(width = 4, ellipsis = ""),
    Month = Time %>%
      stringr::str_trunc(width = 2, side = "left", ellipsis = ""),
    Var = paste(Var, "month", Month, sep = "\n")
  ) %>%
  dplyr::select(-Time) %>%
  dplyr::rename(Time = Year)
NEesp::render_indicator(test, lab = names[1])
```

#### Weekly primary production
```{r, pp-week}
test <- ecodata::chl_pp %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_replace_all("_", "\n") %>%
    stringr::str_replace_all(" ", "\n")) %>%
  dplyr::filter(
    stringr::str_detect(Var, "WEEKLY"),
    stringr::str_detect(Var, "PPD")
  ) %>%
  dplyr::mutate(
    Time = Time %>%
      stringr::str_replace("W_", ""),
    Year = Time %>%
      stringr::str_trunc(width = 4, ellipsis = ""),
    Week = Time %>%
      stringr::str_trunc(width = 2, side = "left", ellipsis = ""),
    Var = paste(Var, "week", Week, sep = "\n")
  ) %>%
  dplyr::select(-Time) %>%
  dplyr::rename(Time = Year)
NEesp::render_indicator(test, lab = names[1])
```

### Zooplankton

#### Spring zooplankton abundance by species
```{r, zoo-oi-spring}
test <- ecodata::zoo_oi %>%
  dplyr::filter(
    Var %>% stringr::str_detect("SD") == FALSE,
    Var %>% stringr::str_detect("spring")
  )
NEesp::render_indicator(test, lab = names[1])
```

#### Fall zooplankton abundance by species
```{r, zoo-oi-fall}
test <- ecodata::zoo_oi %>%
  dplyr::filter(
    Var %>% stringr::str_detect("SD") == FALSE,
    Var %>% stringr::str_detect("fall")
  )
NEesp::render_indicator(test, lab = names[1])
```

#### Zooplankton abundance by group
```{r, zoo-strat-abun}
test <- ecodata::zoo_strat_abun
NEesp::render_indicator(test, lab = names[1])
```

#### Abundance of Calanus CV and adults
```{r, calanus}
test <- ecodata::calanus_stage %>%
  dplyr::rename(Time = Year) %>%
  dplyr::filter(
    Var == "adt" | Var == "c5",
    Units == "No. per 100m^-3"
  ) %>%
  dplyr::group_by(Time, EPU, season) %>%
  dplyr::mutate(Val = sum(Value)) %>%
  dplyr::select(Time, Val, EPU, season) %>%
  dplyr::distinct() %>%
  dplyr::mutate(Var = paste("Calanus CV and adult", season))
NEesp::render_indicator(test, lab = names[1])
```

#### Zooplankton abundance anomaly
```{r, zoo-abund}
test <- ecodata::zoo_abund
NEesp::render_indicator(test, lab = names[1])
```

#### Zooplankton diversity index
```{r, zoo-diversity}
test <- ecodata::zoo_diversity
NEesp::render_indicator(test, lab = names[1])
```

#### Small/large copepod anomaly
```{r, zoo-sli-anom}
test <- ecodata::zoo_sli_anom
NEesp::render_indicator(test, lab = names[1])
```

#### Ichthyoplankton diversity
```{r, ich}
test <- ecodata::ichthyo_diversity
NEesp::render_indicator(test, lab = names[1])
```

### Forage fish abundance
```{r, forage}
test <- ecodata::forage_anomaly
NEesp::render_indicator(test, lab = names[1])
```

<!--chapter:end:03-trophic-indicators.Rmd-->

## Trophic indicators in the stock region

### Chlorophyll in stock region
```{r, chl-stock}
test <- ecodata::ESP_seasonal_chl %>%
  dplyr::mutate(Pattern_check = ESP %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    NEesp::render_indicator(test, lab = names[1])
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

### Primary production in stock region
```{r, pp-stock}
test <- ecodata::ESP_seasonal_pp %>%
  dplyr::mutate(Pattern_check = ESP %>%
    stringr::str_replace_all("_", " ") %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(stringr::str_detect(Pattern_check, params$stock)) %>%
  dplyr::distinct()

if (nrow(test) > 0) {
  if (length(unique(test$Pattern_check)) > 1) {
    # add stock region into var for faceting
    test <- test %>%
      dplyr::mutate(Var = paste(Var, Pattern_check, sep = " ") %>%
        stringr::str_replace_all("_", "") %>%
        stringr::str_wrap(width = 8))
    NEesp::render_indicator(test, lab = names[1])
  } else {
    test <- test %>%
      dplyr::mutate(Var = paste0(Var, "_stock"))

    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "Indicator data has not been parsed over this stock's region"
}
```

### Zooplankton in the stock region

#### Annual zooplankton abundance in the stock region
```{r, zoop-stock-annual}
if (params$stock == "Black sea bass") {
  # load data
  test_big <- NEesp::zoop_stock %>%
    dplyr::filter(
      Species == params$stock,
      Season == "Annual"
    ) %>%
    dplyr::select(-Species, -Season)
  colnames(test_big) <- paste(colnames(test_big), "_annual", sep = "")
  
  zoop_length <- length(colnames(test_big)) - 1 # don't count time column
  zoop_names <- colnames(test_big)[1:zoop_length]

  # update names for saving figs
  names <- c(zoop_names, names[-1])

  # loop child doc
  for (i in 1:zoop_length) {
    test <- tibble::tibble(
      Time = test_big$Time,
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )
    # make section title
    title <- names[1] %>%
      stringr::str_replace_all("_", " ") %>%
      stringr::str_to_title()
    cat(paste("####", title, "{-}"), "\n\n")

    # render section
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

#### Spring zooplankton abundance in the stock region
```{r, zoop-stock-spring}
if (params$stock == "Black sea bass") {
  # load data
  test_big <- NEesp::zoop_stock %>%
    dplyr::filter(
      Species == params$stock,
      Season == "Spring"
    ) %>%
    dplyr::select(-Species, -Season)
  colnames(test_big) <- paste(colnames(test_big), "_spring", sep = "")
  
  zoop_length <- length(colnames(test_big)) -1
  zoop_names <- colnames(test_big)[1:zoop_length]

  # update names for saving figs
  names <- c(zoop_names, names[-1])

  # loop child doc
  for (i in 1:zoop_length) {
    test <- tibble::tibble(
      Time = test_big$Time,
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )

    # make section title
    title <- names[1] %>%
      stringr::str_replace_all("_", " ") %>%
      stringr::str_to_title()
    cat(paste("####", title, "{-}"), "\n\n")

    # render section
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

#### Fall zooplankton abundance in the stock region
```{r, zoop-stock-fall}
if (params$stock == "Black sea bass") {
  # load data
  test_big <- NEesp::zoop_stock %>%
    dplyr::filter(
      Species == params$stock,
      Season == "Fall"
    ) %>%
    dplyr::select(-Species, -Season)
  colnames(test_big) <- paste(colnames(test_big), "_fall", sep = "")

  zoop_length <- length(colnames(test_big)) -1
  zoop_names <- colnames(test_big)[1:zoop_length]

  # update names for saving figs
  names <- c(zoop_names, names[-1])

  # loop child doc
  for (i in 1:zoop_length) {
    test <- tibble::tibble(
      Time = test_big$Time,
      Var = colnames(test_big)[i],
      Val = test_big[, i]
    )
    # make section title
    title <- names[1] %>%
      stringr::str_replace_all("_", " ") %>%
      stringr::str_to_title()
    cat(paste("####", title, "{-}"), "\n\n")

    # render section
    NEesp::render_indicator(test, lab = names[1])
  }
} else {
  "No data for this species yet"
}
```

<!--chapter:end:04-trophic-indicators-stock.Rmd-->

## Larvae and YOY indicators

### Recruitment
```{r, recruit}
test <- stock %>%
  dplyr::filter(Metric == "Recruitment") %>%
  dplyr::rename(
    Var = Metric,
    Val = Value
  )
if (nrow(test) > params$lag) {
  NEesp::render_indicator(test, lab = names[1])
} else {
  names <- names[-1]
  print("No data")
}
```

### Larval growth

<!--chapter:end:05-larvae-YOY.Rmd-->

## Juvenile indicators

### Length-age curves

### Condition

### CPUE

<!--chapter:end:06-juvenile.Rmd-->

## Adult indicators

### Abundance
```{r, abundance}
test <- stock %>%
  dplyr::filter(Metric == "Abundance") %>%
  dplyr::rename(
    Var = Metric,
    Val = Value
  )

if (nrow(test) > params$lag) {
  NEesp::render_indicator(test, lab = names[1])
} else {
  names <- names[-1]
  print("No data")
}
```

### Mean age of spawning stock

### Age distribution

### Length-age curves

### Condition
```{r, condition}
test <- NEesp::cond  %>%
  dplyr::mutate(Species = Species %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(Species == params$stock) %>%
  dplyr::rename(
    Val = MeanCond,
    Time = YEAR
  ) %>%
  dplyr::mutate(Var = paste(sex, "condition"))

if (nrow(test) > 0) {
  NEesp::render_indicator(test, lab = names[1])
} else {
  names <- names[-1]
  print("No data")
}
```

### Stomach fullness
```{r, stomach}
test <- ecodata::stom_fullness %>%
  dplyr::mutate(Var = Var %>%
    stringr::str_to_sentence()) %>%
  dplyr::filter(Var == params$stock)

if (nrow(test) > 0) {
  NEesp::render_indicator(test, lab = names[1])
} else {
  names <- names[-1]
  print("No data")
}
```

### Center of gravity and area occupied

<!--chapter:end:07-adult.Rmd-->

## Socioeconomic indicators

### CPUE by catch strategy

### Recreational CPUE
```{r, rec-cpue}
numbers <- ecodata::recdat %>%
  dplyr::filter(Var == "Recreational Seafood") %>%
  dplyr::rename(Number = Value)

days <- ecodata::recdat %>%
  dplyr::filter(Var == "Recreational Effort") %>%
  dplyr::rename(Days = Value)

test <- dplyr::left_join(numbers, days, by = c("Time", "EPU")) %>%
  dplyr::mutate(
    Val = Number / Days,
    Var = paste("recreational CPUE", "number of fish caught per day fished (all species)", sep = "\n")
  )
NEesp::render_indicator(test, lab = names[1])
```

<!--chapter:end:08-socioeconomic.Rmd-->

# Summary of statistically significant indicators

```{r, output_summary_html, eval = (params$out == "html")}
summary_table <- function(x) {
  DT::datatable(x,
    rownames = FALSE,
    filter = list(
      position = "top",
      clear = FALSE
    ),
    options = list(
      search = list(regex = TRUE),
      paging = FALSE
    )
  )
}
```

```{r, output_summary_word, eval = (params$out == "word")}
summary_table <- function(x) {
  knitr::kable(x)
}
```

```{r}
colnames(output) <- c(
  "Response_variable", "Indicator",
  "Number of data points", "Slope",
  "P-value", "R2_adj"
)
```

## Abundance
```{r}
output %>%
  tibble::as_tibble() %>%
  dplyr::filter(
    Response_variable == "Abundance",
    R2_adj < 1
  ) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()
```

### Generalized linear model

This is an exploratory fit of a poisson GLM. Initial covariates were included based on statistical significance at a Bonferroni-corrected alpha in the linear correlations shown in this report. Final covariates were chosen by forward stepwise AIC selection of additive GLMs.

```{r, bonf}
# bonferroni correction to weed out excess covariates
bonf_p <- 0.05 / bonf_n
```

```{r, wrangle-abun}
eval_dat <- (class(abun_data) != "NULL")

if (eval_dat) {
  abun_data <- abun_data %>%
    dplyr::mutate(Var = Var %>%
      stringr::str_replace_all(" ", "_") %>%
      stringr::str_replace_all("-", "_") %>%
      stringr::str_replace_all("/", "_") %>%
      stringr::str_replace_all("[:^:]", "_") %>%
      stringr::str_replace_all("\n", "_") %>%
      stringr::str_remove_all("\\(") %>%
      stringr::str_remove_all("\\)") %>%
      stringr::str_remove_all(",")) %>%
    dplyr::filter(
      pval < bonf_p,
      Var != "Time"
    ) %>%
    dplyr::select(-pval)
} else {
  "No statistically significant covariates"
}
```

```{r, eval = eval_dat}
# eval_dat
data <- abun_data
type <- "abundance"

if (nrow(data) > 0) {
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      system.file("correlation_bookdown_template/_summary-child-doc.Rmd", package = "NEesp"),
      label = "abundance-model"
    ),
    quiet = TRUE
  )
  cat(res, sep = "\n")
} else {
  "No statistically significant covariates after Bonferroni correction"
}
```


## Recruitment
```{r}
output %>%
  tibble::as_tibble() %>%
  dplyr::filter(
    Response_variable == "Recruitment",
    R2_adj != 1
  ) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()
```

### Generalized linear model

This is an exploratory fit of a poisson GLM. Initial covariates were included based on statistical significance at a Bonferroni-corrected alpha in the linear correlations shown in this report. Final covariates were chosen by forward stepwise AIC selection of additive GLMs.

```{r, wrangle-recruit}
eval_dat <- (class(recruit_data) != "NULL")

if (eval_dat) {
  recruit_data <- recruit_data %>%
    dplyr::mutate(Var = Var %>%
      stringr::str_replace_all(" ", "_") %>%
      stringr::str_replace_all("-", "_") %>%
      stringr::str_replace_all("/", "_") %>%
      stringr::str_replace_all("[:^:]", "_") %>%
      stringr::str_replace_all("\n", "_") %>%
      stringr::str_remove_all("\\(") %>%
      stringr::str_remove_all("\\)") %>%
      stringr::str_remove_all(",")) %>%
    dplyr::filter(
      pval < bonf_p,
      Var != "Time"
    ) %>%
    dplyr::select(-pval)
} else {
  "No statistically significant covariates"
}
```

```{r, eval = eval_dat}
# eval_dat
data <- recruit_data
type <- "recruit"

if (nrow(data) > 0) {
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      system.file("correlation_bookdown_template/_summary-child-doc.Rmd", package = "NEesp"),
      label = "recruitment-model"
    ),
    quiet = TRUE
  )
  cat(res, sep = "\n")
} else {
  "No statistically significant covariates after Bonferroni correction"
}
```

## Catch
```{r}
output %>%
  tibble::as_tibble() %>%
  dplyr::filter(
    Response_variable == "Catch",
    R2_adj != 1
  ) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()
```

## Fmort
```{r}
output %>%
  tibble::as_tibble() %>%
  dplyr::filter(
    Response_variable == "Fmort",
    R2_adj != 1
  ) %>%
  dplyr::select(-Response_variable) %>%
  summary_table()
```


<!--chapter:end:09-summary.Rmd-->

# Appendix

## R session information
```{r, session-info, results = "markup"}
sessionInfo()
```

## `NEesp` information
```{r, NEesp-info, results = "markup"}
packageDescription("NEesp")
```

<!--chapter:end:appendix.Rmd-->

